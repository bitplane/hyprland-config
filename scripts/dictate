#!/bin/bash
# Voice dictation with keyboard feedback

FIFO="/tmp/dictate.fifo"

# Trap to always reset keyboard
trap 'keyboard-reset' EXIT INT TERM

# Set A key red
keyboard-notify --color 255,0,0 A

# Start/wake up daemon with full bash environment
bash -l -c 'dictated' &

# Wait for fifo to have a writer (daemon is ready)
while [ ! -p "$FIFO" ]; do
    sleep 0.1
done

# Drain any existing data from fifo (old transcriptions)
timeout 0.5 cat "$FIFO" > /dev/null 2>&1 || true

# Wait for and read one new line (with timeout)
# grep -m1 stops after first match without needing extra line
text=$(timeout 10 grep -m1 ".*" "$FIFO")

# Type the transcribed text to active window
if [ -n "$text" ]; then
    wtype "$text"
fi

# Keyboard will be reset by trap
