#!/usr/bin/python3
import time
import sys
import glob
import os
import subprocess

def find_razer_device():
    """Auto-detect the Razer keyboard device"""
    devices = glob.glob("/sys/bus/hid/drivers/razerkbd/0003:*")
    for device in devices:
        if os.path.exists(f"{device}/matrix_effect_none"):
            return device
    return None

DEVICE = find_razer_device()
if not DEVICE:
    print("Error: Could not find Razer keyboard device", file=sys.stderr)
    sys.exit(1)

# Digit key positions from keyboard layout
DIGIT_POSITIONS = {
    "1": (1, 2),
    "2": (1, 3),
    "3": (1, 4),
    "4": (1, 5),
    "5": (1, 6),
    "6": (1, 7),
    "7": (1, 8),
    "8": (1, 9),
    "9": (1, 10),
    "0": (1, 11),
}

def get_tmux_window():
    """Get the current tmux window number"""
    try:
        result = subprocess.run(
            ["tmux", "display-message", "-p", "#I"],
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip()
    except:
        return None

def set_effect(effect):
    """Set keyboard effect"""
    try:
        if effect == "reactive":
            # Reactive needs RGB color + speed (1-4)
            with open(f"{DEVICE}/matrix_effect_reactive", "wb") as f:
                f.write(bytes([255, 255, 255, 2]))  # White, medium speed
        else:
            with open(f"{DEVICE}/matrix_effect_{effect}", "w") as f:
                f.write("1")
    except Exception as e:
        print(f"Error setting effect {effect}: {e}", file=sys.stderr)

def flash_keyboard_with_window():
    """Flash keyboard with window number highlighted in red"""
    window = get_tmux_window()

    # Build set of positions to highlight
    highlight_positions = set()
    if window:
        for digit in str(window):
            if digit in DIGIT_POSITIONS:
                highlight_positions.add(DIGIT_POSITIONS[digit])

    try:
        for i in range(2):
            # Set to custom mode
            with open(f"{DEVICE}/matrix_effect_custom", "w") as f:
                f.write("1")

            # Set all keys
            for row in range(6):
                for col in range(22):
                    if (row, col) in highlight_positions:
                        # Red for window number digits
                        frame_data = bytes([row, col, col, 255, 0, 0])
                    else:
                        # Orange for all other keys
                        frame_data = bytes([row, col, col, 128, 40, 0])

                    with open(f"{DEVICE}/matrix_custom_frame", "wb") as f:
                        f.write(frame_data)

            time.sleep(0.5)

            # Off - black
            for row in range(6):
                for col in range(22):
                    frame_data = bytes([row, col, col, 0, 0, 0])
                    with open(f"{DEVICE}/matrix_custom_frame", "wb") as f:
                        f.write(frame_data)

            time.sleep(0.5)
    finally:
        # Always restore to reactive (default)
        set_effect("reactive")

if __name__ == "__main__":
    flash_keyboard_with_window()
