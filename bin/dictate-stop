#!/bin/bash
# Stop recording and transcribe on key release

CACHE_DIR="$HOME/.cache/dictate"
LOCKFILE="$CACHE_DIR/recording.lock"
TSV_FILE="$CACHE_DIR/data.tsv"

# Not recording? Bail out
if [ ! -f "$LOCKFILE" ]; then
    keyboard-reset
    exit 0
fi

# Read PID and filename, then remove lockfile
read PID WAVFILE < "$LOCKFILE"
rm -f "$LOCKFILE"

# Kill the recording process
kill "$PID" 2>/dev/null
sleep 0.1

# Check if WAV file exists and has content
if [ ! -s "$WAVFILE" ]; then
    keyboard-reset
    exit 1
fi

# Set A key green (transcribing)
keyboard-notify --color 0,255,0 A

# Send to Whisper server for transcription
RESPONSE=$(curl -s -X POST -F "file=@$WAVFILE" http://127.0.0.1:8000/v1/audio/transcriptions)

# Extract text from JSON response
TEXT=$(echo "$RESPONSE" | jq -r '.text // empty')

if [ -z "$TEXT" ]; then
    keyboard-reset
    exit 1
fi

# Append to TSV file
RELATIVE_FILE=$(basename "$(dirname "$WAVFILE")")/$(basename "$WAVFILE")
echo -e "$RELATIVE_FILE\t$TEXT" >> "$TSV_FILE"

# Set A key blue (typing)
keyboard-notify --color 0,100,255 A

# Type the text
wtype "$TEXT"

# Reset keyboard
keyboard-reset
