#!/bin/bash
# Start recording on key press

CACHE_DIR="$HOME/.cache/dictate"
LOCKFILE="$CACHE_DIR/recording.lock"

# Already recording? Bail out
[ -f "$LOCKFILE" ] && exit 0

# Create cache directory structure
mkdir -p "$CACHE_DIR/$(date +%Y-%m)"

# Generate filename
WAVFILE="$CACHE_DIR/$(date +%Y-%m)/$(date +%Y-%m-%d_%H:%M:%S).wav"

# Write lockfile immediately (PID and filename)
echo "$$ $WAVFILE" > "$LOCKFILE"

# Set A key red
keyboard-notify --color 255,0,0 A

# Become sox (16kHz mono for Whisper)
exec sox -d -r 16000 -c 1 "$WAVFILE"
